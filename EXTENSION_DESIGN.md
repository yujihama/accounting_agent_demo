# 経理業務ツール拡張設計

## 概要

既存の請求書チェックツールを拡張し、多様な経理業務に対応する統合ツールとして発展させる設計です。

## 設計原則

### 1. 既存機能の保持
- 既存の請求書チェック機能は完全に保持
- 既存のコードベースへの影響を最小限に抑制
- 段階的な拡張が可能な構造

### 2. プラグイン型アーキテクチャ
- 請求書チェック = 1つのプラグイン
- 経理業務処理 = 新しいプラグイン
- 共通機能はコアモジュールとして分離

### 3. 設定駆動
- 業務ロジックをJSONで設定
- UI上でカスタマイズ可能
- 新しい業務パターンを簡単に追加

## アーキテクチャ

```
extract_invoice/
├── app.py                    # 既存アプリ（請求書チェック専用）
├── app_extended.py           # 拡張版アプリ（統合）
├── core/                     # 共通コア機能
│   ├── folder_processor.py   # フォルダ処理
│   ├── excel_manager.py      # Excel操作
│   ├── llm_client.py         # LLM統合
│   └── task_engine.py        # タスク実行エンジン
├── config/
│   └── task_configs.json     # タスク設定
└── （既存ファイル群）
```

## 新機能詳細

### 1. 証跡フォルダ処理
- **目的**: 2階層構造のフォルダをアップロード・処理
- **対応形式**: ZIP圧縮フォルダ
- **構造**: データフォルダ/ドキュメントファイル
- **機能**: 
  - 自動的なドキュメント分類
  - メタデータ抽出
  - バリデーション

### 2. 調書（Excel）操作
- **目的**: 処理結果をExcelの指定箇所に記載
- **機能**:
  - 動的シート選択
  - セル範囲指定
  - スタイル設定
  - データ形式変換

### 3. LLM統合処理
- **モデル**: GPT-4.1（ユーザー要望に基づく）
- **機能**:
  - 証跡データ分析
  - 指示に基づく処理実行
  - 構造化された結果出力
  - エラーハンドリング

### 4. タスクエンジン
- **目的**: 業務処理の統合管理
- **機能**:
  - 設定駆動処理
  - プレビュー実行
  - バッチ処理
  - 結果検証

## 利用フロー

### 基本的な使用手順

1. **ツール選択**
   - 請求書チェック（既存機能）
   - 経理業務処理（新機能）

2. **経理業務処理の場合**
   ```
   タスク設定 → 証跡アップロード → 調書アップロード → 
   処理実行 → 結果確認・ダウンロード
   ```

3. **各ステップ詳細**
   - **タスク設定**: 既存テンプレートまたはカスタム作成
   - **証跡アップロード**: ZIP形式の2階層フォルダ
   - **調書アップロード**: 結果記載用Excelファイル
   - **処理実行**: AI指示＋プレビュー実行＋本実行
   - **結果確認**: サマリー表示＋調書ダウンロード

## 設定例

### タスク設定（config/task_configs.json）

```json
{
  "accounting_task_1": {
    "name": "請求書・入金明細照合",
    "description": "請求書と入金明細を照合し、結果を調書に記載",
    "output_config": {
      "target_sheet": "結果",
      "start_cell": "B3",
      "columns": [
        {"key": "data_id", "header": "データID"},
        {"key": "invoice_amount", "header": "請求金額"},
        {"key": "payment_amount", "header": "入金金額"},
        {"key": "match_status", "header": "照合結果"},
        {"key": "variance", "header": "差額"},
        {"key": "remarks", "header": "備考"}
      ]
    }
  }
}
```

## 拡張可能性

### 1. 新しい業務タイプの追加
- タスク設定の追加のみで新業務に対応
- カスタムプロンプトテンプレート
- 出力フォーマットのカスタマイズ

### 2. ドキュメント処理の拡張
- 新しいファイル形式への対応
- OCR機能の追加
- 画像解析機能

### 3. 出力形式の拡張
- PDF出力
- CSV出力
- データベース連携

## セキュリティ・運用考慮事項

### 1. データ保護
- ファイルの一時保存期間制限
- セッション管理
- APIキーの安全な管理

### 2. エラーハンドリング
- 段階的なバリデーション
- 詳細なエラーメッセージ
- ロールバック機能

### 3. パフォーマンス
- 大量データ処理への対応
- 並列処理の最適化
- メモリ効率

## 移行戦略

### フェーズ1: 基盤構築
- コアモジュールの実装
- 基本的なタスクテンプレート作成
- 既存機能との共存確認

### フェーズ2: 機能拡充
- 追加業務パターンの実装
- UI/UXの改善
- エラーハンドリングの強化

### フェーズ3: 高度化
- 機械学習機能の追加
- 外部システム連携
- レポート機能の強化

## 技術仕様

### 主要技術スタック
- **フロントエンド**: Streamlit
- **AI/LLM**: OpenAI GPT-4.1
- **データ処理**: Pandas, openpyxl
- **ファイル処理**: PyPDF2, python-docx, Pillow

### APIキー管理
```python
# GPT-4.1の明示的な使用
model = "gpt-4.1"
```

### 設定管理
- JSON形式でのタスク定義
- 動的設定読み込み
- ホットリロード対応